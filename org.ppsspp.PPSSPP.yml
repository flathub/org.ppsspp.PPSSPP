app-id: org.ppsspp.PPSSPP
runtime: org.freedesktop.Platform
runtime-version: '21.08'
sdk: org.freedesktop.Sdk
rename-icon: ppsspp
rename-desktop-file: PPSSPPSDL.desktop
rename-appdata-file: appdata.xml
command: PPSSPPSDL
finish-args:
  - --device=all
  - --filesystem=host:ro
  - --socket=pulseaudio
  - --socket=x11
  - --share=network
modules:
  - shared-modules/glu/glu-9.json
  - shared-modules/glew/glew.json
  - name: ppsspp
    buildsystem: simple
    build-options:
      arch:
        aarch64:
          env:
            EXTRA_OPTS: '-DUSING_GLES2=ON'
    build-commands:
      - cd ffmpeg && rm -r linux && ../build-ffmpeg.sh
      - cmake 
        -DCMAKE_BUILD_TYPE=RelWithDebInfo 
        -DCMAKE_INSTALL_PREFIX=${FLATPAK_DEST} 
        ${EXTRA_OPTS} 
        .
      - make -j${FLATPAK_BUILDER_N_JOBS} && make install
    post-install:
      - desktop-file-edit --set-name=PPSSPP --set-icon=${FLATPAK_ID} ${FLATPAK_DEST}/share/applications/PPSSPPSDL.desktop
      - install -Dm644 appdata.xml -t ${FLATPAK_DEST}/share/appdata
    sources:
      - type: git
        url: https://github.com/hrydgard/ppsspp.git
        tag: v1.12

      - type: file
        path: appdata.xml

      - type: script
        dest-filename: build-ffmpeg.sh
        only-arches: 
          - aarch64
        commands:
          - sed -i 's/GENERAL=/GENERAL_NO=/' linux_arm64.sh
          - ./linux_arm64.sh

      - type: script
        dest-filename: build-ffmpeg.sh
        only-arches: 
          - x86_64
        commands:
          - ./linux_x86-64.sh
